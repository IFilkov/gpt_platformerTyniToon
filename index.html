<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Простой платформер</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }

      canvas {
        display: block;
      }
    </style>
  </head>
  <body>
    <canvas id="gameCanvas"></canvas>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");

      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const hero = {
        x: 50,
        y: canvas.height - 50,
        width: 30,
        height: 30,
        color: "red",
        speed: 5,
        jumpHeight: 6 * 30,
        jumpStartY: 0,
        isJumping: false,
        onLadder: false,
        onPlatform: false,
        isFalling: false,
        fallStartY: 0,
        score: 0,
      };

      const ladder = {
        x: canvas.width / 2 - 15,
        y: 0,
        width: 30,
        height: canvas.height,
        color: "gray",
      };

      const girls = [
        // Позиции девушек (x, y) и их текущий таймер
        {
          x: canvas.width / 2 + 50,
          y: canvas.height - 120,
          width: 30,
          height: 30,
          color: "pink",
          timer: 0,
          isActive: true,
        },
        {
          x: canvas.width / 2 + 250,
          y: canvas.height - 120,
          width: 30,
          height: 30,
          color: "pink",
          timer: 0,
          isActive: true,
        },

        // Добавьте дополнительные девушки, если нужно
      ];

      const platforms = [
        // Первый столбик
        {
          x: canvas.width / 2 + 50,
          y: canvas.height - 80,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 50,
          y: canvas.height - 160,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 50,
          y: canvas.height - 240,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 50,
          y: canvas.height - 320,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 50,
          y: canvas.height - 400,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 50,
          y: canvas.height - 480,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 50,
          y: canvas.height - 560,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 50,
          y: canvas.height - 620,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 50,
          y: canvas.height - 700,
          width: 180,
          height: 30,
          color: "blue",
        },
        // Второй столбик
        {
          x: canvas.width / 2 + 250,
          y: canvas.height - 80,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 250,
          y: canvas.height - 160,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 250,
          y: canvas.height - 240,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 250,
          y: canvas.height - 320,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 250,
          y: canvas.height - 400,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 250,
          y: canvas.height - 480,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 250,
          y: canvas.height - 560,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 250,
          y: canvas.height - 620,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 250,
          y: canvas.height - 700,
          width: 180,
          height: 30,
          color: "blue",
        },
        // Третий столбик
        {
          x: canvas.width / 2 + 450,
          y: canvas.height - 80,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 450,
          y: canvas.height - 160,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 450,
          y: canvas.height - 240,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 450,
          y: canvas.height - 320,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 450,
          y: canvas.height - 400,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 450,
          y: canvas.height - 480,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 450,
          y: canvas.height - 560,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 450,
          y: canvas.height - 620,
          width: 180,
          height: 30,
          color: "blue",
        },
        {
          x: canvas.width / 2 + 450,
          y: canvas.height - 700,
          width: 180,
          height: 30,
          color: "blue",
        },
        // Четвертый столбик
      ];

      const blackSquares = [
        {
          x: canvas.width / 2 + 10,
          y: canvas.height - 120,
          width: 30,
          height: 30,
          color: "OrangeRed",
          speedX: -2,
          speedY: 2,
          platform: null,
          ladder: null,
          isActive: true,
        },
        {
          x: canvas.width / 2 + 250,
          y: canvas.height - 240,
          width: 30,
          height: 30,
          color: "SpringGreen",
          speedX: -2,
          speedY: 2,
          platform: null,
          ladder: null,
          isActive: true,
        },
        {
          x: canvas.width / 2 + 250,
          y: canvas.height - 240,
          width: 30,
          height: 30,
          color: "SlateBlue",
          speedX: -2,
          speedY: 2,
          platform: null,
          ladder: null,
          isActive: true,
        },
        {
          x: canvas.width / 2 + 250,
          y: canvas.height - 240,
          width: 30,
          height: 30,
          color: "tomato",
          speedX: -2,
          speedY: 2,
          platform: null,
          ladder: null,
          isActive: true,
        },
        // Черные квадраты сверху
        {
          x: canvas.width / 2 + 50,
          y: canvas.height - 240,
          width: 30,
          height: 30,
          color: "lime",
          speedX: 2, // Скорость по горизонтали
          speedY: -2, // Скорость по вертикали
          platform: null,
          ladder: null,
          isActive: true,
        },
        {
          x: canvas.width / 2 + 10,
          y: canvas.height - 120,
          width: 30,
          height: 30,
          color: "Olive",
          speedX: -2,
          speedY: -2,
          platform: null,
          ladder: null,
          isActive: true,
        },
        // Черные квадраты снизу
        {
          x: canvas.width / 2 + 50,
          y: canvas.height - 240,
          width: 30,
          height: 30,
          color: "black",
          speedX: 2,
          speedY: 2,
          platform: null,
          ladder: null,
          isActive: true,
        },
        {
          x: canvas.width / 2 + 250,
          y: canvas.height - 240,
          width: 30,
          height: 30,
          color: "black",
          speedX: -2,
          speedY: 2,
          platform: null,
          ladder: null,
          isActive: true,
        },
      ];

      function getRandomPlatform() {
        const randomIndex = Math.floor(Math.random() * platforms.length);
        return platforms[randomIndex];
      }

      function updateBlackSquarePosition(square) {
        // Если прошло более 20 секунд, изменяем платформу
        if (platformChangeTimer >= 20) {
          square.platform = getRandomPlatform();
          platformChangeTimer = 0; // Сбрасываем таймер изменения платформы
        }

        // Логика перемещения по текущей платформе
        if (square.platform) {
          square.x += square.speedX;

          if (
            square.x + square.width >
              square.platform.x + square.platform.width ||
            square.x < square.platform.x
          ) {
            square.speedX *= -1; // Меняем направление, если достигли границ платформы
          }
        }
      }

      function generateBlackSquares() {
        platforms.forEach((platform) => {
          const square = {
            x: platform.x + Math.random() * (platform.width - 30), // 30 - ширина квадрата
            y: platform.y - 30, // Размещаем квадрат над платформой
            width: 30,
            height: 30,
            color: "black",
            speedX: Math.random() < 0.5 ? 2 : -2, // Случайное направление по горизонтали
            speedY: Math.random() < 0.5 ? 2 : -2, // Случайное направление по вертикали
            platform: platform,
            ladder: null,
            isActive: true,
          };
          blackSquares.push(square);
        });
      }

      // generateBlackSquares();

      function drawBlackSquares() {
        blackSquares.forEach((square) => {
          if (square.isActive) {
            ctx.fillStyle = square.color;
            ctx.fillRect(square.x, square.y, square.width, square.height);
          }
        });
      }

      let platformChangeTimer = 0;

      function updateBlackSquares() {
        blackSquares.forEach((square) => {
          if (square.isActive) {
            // Обновите позицию каждого черного квадрата, например, вызвав функцию, которую вы используете для их перемещения
            updateBlackSquarePosition(square);
          }
        });
      }

      setInterval(updateBlackSquares, 2000); // Обновляет черные квадраты каждые 20 секунд

      function moveBlackSquares() {
        blackSquares.forEach((square) => {
          if (square.isActive) {
            // Логика движения остается без изменений

            // Если квадрат вышел за границы canvas, изменяем направление
            if (
              square.x + square.speedX > canvas.width - square.width ||
              square.x + square.speedX < 0
            ) {
              square.speedX *= -1;
            }

            if (
              square.y + square.speedY > canvas.height - square.height ||
              square.y + square.speedY < 0
            ) {
              square.speedY *= -1;
              1;
            }

            square.x += square.speedX;
            square.y += square.speedY;

            // Проверка на соприкосновение с платформой
            platforms.forEach((platform) => {
              if (
                square.x < platform.x + platform.width &&
                square.x + square.width > platform.x &&
                square.y + square.height > platform.y &&
                square.y < platform.y + platform.height
              ) {
                // Обновляем координаты квадрата в соответствии с платформой
                square.y = platform.y - square.height;
                // Ограничиваем перемещение в пределах платформы
                if (
                  square.x < platform.x ||
                  square.x + square.width > platform.x + platform.width
                ) {
                  square.speedX *= -1; // Меняем направление по горизонтали
                }

                if (square.y + square.speedY > platform.y) {
                  square.speedY *= -1; // Меняем направление по вертикали
                }
              }
            });

            square.x += square.speedX;
            square.y += square.speedY;
          }
        });
      }

      // ... (остальные функции отрисовки без изменений)

      function drawBlackSquares() {
        blackSquares.forEach((square) => {
          if (square.isActive) {
            ctx.fillStyle = square.color;
            ctx.fillRect(square.x, square.y, square.width, square.height);
          }
        });
      }

      const keys = {};
      window.addEventListener("keydown", (e) => (keys[e.code] = true));
      window.addEventListener("keyup", (e) => (keys[e.code] = false));

      function gameLoop() {
        update();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawLadder();
        drawPlatforms();
        drawGirls();
        drawBlackSquares();
        drawHero();
        drawScore();
        requestAnimationFrame(gameLoop);
      }

      const blueSquare = {
        x: canvas.width / 2 + 450,
        y: canvas.height - 700,
        width: 30,
        height: 30,
        color: "aqua",
        totalScore: 0,
      };

      let savedScore = 0;

      function update() {
        if (keys["ArrowLeft"] && hero.x > 0) {
          hero.x -= hero.speed;
        }

        if (keys["ArrowRight"] && hero.x < canvas.width - hero.width) {
          hero.x += hero.speed;
        }

        if (
          keys["Space"] &&
          !hero.isJumping &&
          (hero.onLadder || hero.onPlatform)
        ) {
          hero.isJumping = true;
          hero.jumpStartY = hero.y;
          hero.jumpDirection = 1;
        }

        if (keys["ArrowUp"] && hero.onLadder) {
          hero.y -= hero.speed;
        }

        if (keys["ArrowDown"] && hero.onLadder) {
          hero.y += hero.speed;
        }

        if (keys["ArrowDown"] && hero.onPlatform) {
          // Если герой на платформе и нажата стрелка вниз, он начинает падать
          hero.isFalling = true;
          hero.fallStartY = hero.y;
        }

        if (hero.isJumping) {
          if (hero.jumpDirection === 1) {
            hero.y =
              hero.jumpStartY -
              Math.pow(hero.jumpHeight - (hero.y - hero.jumpStartY), 2) / 100;

            if (hero.y <= hero.jumpStartY - hero.jumpHeight) {
              hero.jumpDirection = -1;
            }
          } else {
            hero.y += 5;

            if (hero.y >= canvas.height - hero.height) {
              hero.isJumping = false;
              hero.y = canvas.height - hero.height;
            }
          }
        }

        if (hero.isFalling) {
          hero.y += 5;

          if (hero.y >= canvas.height - hero.height) {
            hero.isFalling = false;
            hero.y = canvas.height - hero.height;
          }

          // Проверка на соприкосновение с платформой во время падения
          hero.onPlatform = platforms.some(
            (platform) =>
              hero.x < platform.x + platform.width &&
              hero.x + hero.width > platform.x &&
              hero.y + hero.height > platform.y &&
              hero.y < platform.y + platform.height
          );

          // Если герой снова находится на платформе, завершаем падение
          if (hero.onPlatform) {
            hero.isFalling = false;
            hero.fallStartY = 0;
          }
        }

        // Проверка на соприкосновение с лестницей
        if (
          hero.x < ladder.x + ladder.width &&
          hero.x + hero.width > ladder.x &&
          hero.y + hero.height > ladder.y &&
          hero.y < ladder.y + ladder.height
        ) {
          hero.onLadder = true;
          hero.onPlatform = false;
        } else {
          hero.onLadder = false;

          // Проверка на соприкосновение с верхней частью платформы
          hero.onPlatform = platforms.some(
            (platform) =>
              hero.x < platform.x + platform.width &&
              hero.x + hero.width > platform.x &&
              hero.y < platform.y
          );

          // Если герой не на лестнице и не на верхней части платформы и не в прыжке, пусть он падает вниз
          if (!hero.isJumping && !hero.onPlatform && !hero.isFalling) {
            hero.y += 5;
            if (hero.y >= canvas.height - hero.height) {
              hero.y = canvas.height - hero.height;

              // Проверка на выход героя из зоны коллизии с розовыми квадратами
              if (
                hero.x > girls[0].x + girls[0].width ||
                hero.x + hero.width < girls[0].x ||
                hero.y > girls[0].y + girls[0].height ||
                hero.y + hero.height < girls[0].y
              ) {
                // Обнуление очков героя
                hero.score = 0;
              }
            }
          }

          // if (
          //   hero.x < blueSquare.x + blueSquare.width &&
          //   hero.x + hero.width > blueSquare.x &&
          //   hero.y + hero.height > blueSquare.y &&
          //   hero.y < blueSquare.y + blueSquare.height
          // ) {
          //   if (!blueSquare.isActive) {
          //     savedScore = hero.score; // Сохраняем текущее количество очков
          //     blueSquare.isActive = true;
          //   }
          // } else {
          //   if (blueSquare.isActive) {
          //     hero.score = savedScore; // Восстанавливаем сохраненные очки при выходе из коллизии
          //     blueSquare.isActive = false;
          //   }
          // }

          if (
            hero.x < blueSquare.x + blueSquare.width &&
            hero.x + hero.width > blueSquare.x &&
            hero.y + hero.height > blueSquare.y &&
            hero.y < blueSquare.y + blueSquare.height
          ) {
            if (!blueSquare.isActive) {
              // Сохраняем текущий счет в total score
              blueSquare.totalScore += hero.score;
              blueSquare.isActive = true;
              hero.score = 0; // Обнуляем текущий счет героя
            }
          } else {
            if (blueSquare.isActive) {
              // Восстанавливаем сохраненный счет при выходе из коллизии
              blueSquare.isActive = false;
            }
          }
        }
        placeBlueSquareOnTop();
        handleGirlCollision();
        updateGirlsTimer();
        moveBlackSquares();
      }

      function placeBlueSquareOnTop() {
        let topPlatform = platforms[0]; // Инициализируем первой платформой

        // Находим платформу, на которой находится герой
        // for (let i = 1; i < platforms.length; i++) {
        //   if (hero.y < platforms[i].y) {
        //     topPlatform = platforms[i];
        //   }
        // }

        // Размещаем голубой квадрат сверху этой платформы
        blueSquare.x =
          topPlatform.x + (topPlatform.width - blueSquare.width) / 2;
        blueSquare.y = topPlatform.y - blueSquare.height;
      }

      function updateGirlsTimer() {
        girls.forEach((girl) => {
          if (girl.timer > 0 && girl.isActive) {
            girl.timer += 1 / 60; // Уменьшаем таймер при каждом обновлении игрового цикла (60 раз в секунду)

            // Добавляем проверку на количество очков героя
            if (hero.score >= 200) {
              // Если количество очков достигло 200, сбрасываем таймер и делаем девушку неактивной
              girl.timer = 0;
              hero.score = 0;
              girl.isActive = false;
            }
          }
        });
      }

      function handleGirlCollision() {
        girls.forEach((girl) => {
          if (
            hero.x < girl.x + girl.width &&
            hero.x + hero.width > girl.x &&
            hero.y < girl.y + girl.height &&
            hero.y + hero.height > girl.y &&
            girl.isActive
          ) {
            if (girl.timer === 0) {
              girl.timer = 1 / 60; // 1 секунда
            } else {
              if (girl.timer >= 10) {
                // После 10 секунд убираем розовый квадрат
                if (Math.random() < 0.33) {
                  // С вероятностью 1/3 сбрасываем очки на 0
                  hero.score = 0;
                } else {
                  hero.score += 100; // Иначе начисляем очки
                }
                girl.isActive = false;
                girl.timer = 0; // Сбрасываем таймер
              } else {
                // До 10 секунд продолжаем увеличивать таймер
                girl.timer += 1 / 60;
              }
            }
          } else {
            girl.timer = 0;
          }
        });
      }

      function drawHero() {
        ctx.fillStyle = hero.color;
        ctx.fillRect(hero.x, hero.y, hero.width, hero.height);
      }

      function drawLadder() {
        ctx.fillStyle = ladder.color;
        ctx.fillRect(ladder.x, ladder.y, ladder.width, ladder.height);
      }

      function drawPlatforms() {
        platforms.forEach((platform) => {
          ctx.fillStyle = platform.color;
          ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
        });
        drawBlueSquare();
      }

      function drawBlueSquare() {
        ctx.fillStyle = blueSquare.color;
        ctx.fillRect(
          blueSquare.x,
          blueSquare.y,
          blueSquare.width,
          blueSquare.height
        );
      }

      function createPlatformBlock(x, y) {
        const block = [
          { x: x, y: y - 808, width: 180, height: 30, color: "blue" },
          { x: x, y: y - 80, width: 180, height: 30, color: "blue" },
          { x: x, y: y - 160, width: 180, height: 30, color: "blue" },
          { x: x, y: y - 240, width: 180, height: 30, color: "blue" },
          { x: x, y: y - 320, width: 180, height: 30, color: "blue" },
          { x: x, y: y - 400, width: 180, height: 30, color: "blue" },
          { x: x, y: y - 480, width: 180, height: 30, color: "blue" },
          { x: x, y: y - 560, width: 180, height: 30, color: "blue" },
          { x: x, y: y - 620, width: 180, height: 30, color: "blue" },
          { x: x, y: y - 700, width: 180, height: 30, color: "blue" },
          //следующий этаж
          { x: x - 200, y: y - 808, width: 180, height: 30, color: "blue" },
          { x: x - 200, y: y - 160, width: 180, height: 30, color: "blue" },
          { x: x - 200, y: y - 240, width: 180, height: 30, color: "blue" },
          { x: x - 200, y: y - 320, width: 180, height: 30, color: "blue" },
          { x: x - 200, y: y - 400, width: 180, height: 30, color: "blue" },
          { x: x - 200, y: y - 480, width: 180, height: 30, color: "blue" },
          { x: x - 200, y: y - 560, width: 180, height: 30, color: "blue" },
          { x: x - 200, y: y - 620, width: 180, height: 30, color: "blue" },
          { x: x - 200, y: y - 700, width: 180, height: 30, color: "blue" },
          { x: x - 200, y: y - 80, width: 180, height: 30, color: "blue" },
        ];

        // Добавляем розовые квадратики к каждой платформе
        for (let i = 0; i < block.length; i++) {
          const girl = generateRandomGirlPosition(block[i]);
          girls.push(girl);
        }

        // Добавляем блок в массив платформ
        platforms.push(...block);
      }

      // Вызываем функцию для создания блока слева от лестницы
      createPlatformBlock(canvas.width / 2 - 250, canvas.height);

      function drawGirls() {
        girls.forEach((girl) => {
          if (girl.isActive) {
            ctx.fillStyle = girl.color;
            ctx.fillRect(girl.x, girl.y, girl.width, girl.height);
          }
        });
      }

      function drawScore() {
        ctx.font = "24px Arial";
        ctx.fillStyle = "black";
        ctx.fillText("Score: " + hero.score, 10, 30);
        ctx.fillText("Total Score: " + blueSquare.totalScore, 10, 60);
      }

      function generateRandomGirlPosition(platform) {
        const x = platform.x + Math.random() * (platform.width - 30); // 30 - ширина девушки
        const y = platform.y - 30; // Размещаем девушку над платформой
        return { x, y };
      }

      function generateGirls() {
        platforms.forEach((platform) => {
          // Генерируем девушек на каждой платформе
          for (let i = 0; i < 2; i++) {
            const { x, y } = generateRandomGirlPosition(platform);
            const girl = {
              x,
              y,
              width: 30,
              height: 30,
              color: "pink",
              timer: 0,
              isActive: true,
            };
            girls.push(girl);
          }
        });
      }

      generateGirls();

      gameLoop();
    </script>
  </body>
</html>
